<div class="content-box mb-3 content-lighten">
<h2><i class="fa fa-book fa-fw"></i>hmPSの基礎中の基礎のAPI</h2>
</div>

<div class="content-box mb-3 content-lighten">
    <h3>概要</h3>
    <p>秀丸マクロから呼び出すhmPSの関数(API)は多くありません。</p>
    <p>ほとんどの場合は、「DoString」だけを使うこととなるでしょう。<br>
    </p>
    <p>PowerShellファイルを別ファイルにした場合には、「DoFile」を使うことになるハズです。</p>
    <ul class="pointlist">
        <li>
        <h4>命令の実行:<br>
        &nbsp;└ DoString(szexpression)</h4>
        <p><span class="positive">文字列「szexpression」をPowerShellの命令として実行します。</span><br>
        </p>
        <p>何らかの明確な内部エラーがあった場合は0が、とりあえず実行できた場合は1が返ってきます。 <br>
        </p>
        <ul class="arrowlist">
            <li>
            <h5>１つのマクロ内で「DoString」は複数回実行可能、変数空間も同じ</h5>
            <div class="code"><pre class="brush:ps">#PS = loaddll( hidemarudir + @"\hmPS.dll" );

#_ = dllfuncw( #PS, "DoString", R"PS(

  $aaa = "あいうお";

  function mysum($a, $b) {
    return $a + $b;
  }

)PS"
);


#bbb = 123;

#_ = dllfuncw( #PS, "DoString", R"PS(
  $bbb = $hm::Macro::Var['#bbb'];
  $ccc = $aaa + "続いている"; # 別のDoStringでも、aaa は引き続き利用できる。

  $hm::Macro::Var['$ddd'] = $ccc;
  $result = mysum 1 2
  $hm::debuginfo( $result ); # 別のDoStringで定義した関数も当然利用できる。

)PS"
);

message($ddd);

freedll( #PS );
</pre></div>
        </li></ul>
        <p><br>
        <br>
        </p>
        </li><li>
        <h4>命令の実行:<br>
        &nbsp;└ DoFile(filename)</h4>
        <p><span class="positive">ファイル名「filename」内の記述内容全体をDoString(...)の引数に渡したものとして実行します。</span><br>
        </p>
        <p>何らかの明確な内部エラーがあった場合は0が、とりあえず実行できた場合は1が返ってきます。 <br>
        </p>
        <ul class="arrowlist">
            <li>
            <h5>１つのマクロ内で「DoFile」は複数回実行可能、変数空間も同じ</h5>
            <p>繰り返しになりますが、DoFileとは、「該当のファイルの中身をそのままDoStringに渡す」ということですので、<br>
            複数個のファイルを利用することが可能です。<br>
            この際は、<span class="negative">変数名の衝突などに注意してください。</span></p>
        </li></ul>
        <p><br>
        <br>
        </p>
        </li><li>
        <h4>.psファイルの文字コードの変更など:<br>
        &nbsp;└ SetCodePage(codepage)</h4>
        <p>「.ps」ファイルは、「utf8(BOM無)」「utf8(BOM有)」「utf16(BOM有)」のいずれかが想定されています。<br>
        それ以外で取り扱いたい場合、「SetCodePage」関数を利用してください。<br>
        この関数は「読み込み対象のファイル」が、該当のコードで記述してある、 という指定となります。</p>
        <ul class="arrowlist">
            <li>
            <h5>秀丸マクロ側の記述</h5>
            <p>例えば、以下のようにすることで、
            </p><ul>
                <li>読み込み対象の.psファイルはcp932(shift-jis)で記述してあるということになります。
                </li><li>932:ShiftJIS(=cp932), 1200(utf16), 65001(utf8)となります。
            </li></ul>
            <p>基本的にまともに取り扱うことが出来る文字コードには、必ず「コードページ」が割り振られているため、あらゆるものに対応できます。</p>
            <div class="code"><pre class="brush:ps">#PS = loaddll( hidemarudir + @"\hmPS.dll" );

// 読み込み対象のファイルである「.psファイル」は指定のコードページで書かれてます(932=cp932≒ShiftJIS)ですよ、という指定
#_ = dllfuncw(#PS, "SetCodePage", 932 );

#_ = dllfuncw(#PS, "DoFile", currentmacrodirectory + @"\test.ps" );

freedll(#PS);
</pre></div>
            </li><li>
            <h5>PowerShell側の記述</h5>
            <fieldset class="code"><legend>test.ps</legend><pre class="brush:ps">$hm::debuginfo("テストテスト");
</pre></fieldset>
        </li></ul>
    </li></ul>
</div>

