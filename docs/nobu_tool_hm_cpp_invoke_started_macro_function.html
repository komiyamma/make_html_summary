<div class="content-box mb-3 content-lighten">
    <h2><i class="fa fa-book fa-fw"></i>～秀丸マクロを「関数」を文字列で実行～</h2>
</div>
<div class="content-box mb-3 content-lighten">
    <h3>概要</h3>
    <p><mark>この機能を利用する場合、秀丸エディタ v8.98 (正式版 or β9以上)を強く推奨します。<br>
            そうでない場合、数値と文字列の型を間違えて実行すると秀丸が不正な状態となります。</mark></p>
    <p>
        Hm.Macro.doEval(...)を「関数向けに特化」したものとして、「Hm.Macro.doFunction」が用意されています。
    </p>
    <p>秀丸マクロにおいて「関数」とは</p>
    <blockquote>$ret = sprintf(....);</blockquote>
    <p>のように呼び出しに<mark>「( )」を利用し、返り値を受け取る形</mark>になっているものです。</p>
    <p>一方、<a href="?page=nobu_tool_hm_cpp_invoke_started_macro_statement">類似ですが関数のようでいて「返り値」がなく、「( )」もないものは秀丸マクロでは「文」もしくは「命令文」</a>としています。<br>
    </p>
</div>
<div class="content-box mb-3 content-lighten">
    <h3>
        秀丸マクロの関数を実行可能です。<br>
    </h3>
    <p><mark>マクロ実行中のみ実行可能</mark></p>
    <blockquote>Hm.Macro.doFunction(wstring func_name, ...関数の引数);</blockquote>
    <ul class="pointlist">
        <li>
            <h4>C++側のソース</h4>
            <fieldset class="code">
                <legend>dllmain.cpp</legend>
                <pre class="brush:cpp;highlight:[10]">#include "HmCppInvoke.h"

using namespace Hidemaru;
using namespace std;

extern "C" __declspec(dllexport) THmNumber test() {
    Hm.funcDllExport();

    try {
        auto ret = Hm.Macro.doFunction(L"sprintf", L"%03d%s", 555, L"あいうえお"); // 秀丸マクロ関数の「sprintf」を呼び出してみる例。
        if (! ret.getException() )
        {
            wstring retValue = ret.getResult&lt;wstring&gt;(); // getResult() には「関数(今回の場合sprintf)の返り値」が入っている。
            auto updatedArgs = ret.getArgs(); // getArgsには引数("%03d", 555)の関数実行後の値がvector&lt;THmMacroVariable&gt;の形で格納されている。
                                        // この機能は秀丸マクロの「getlinecount」など引数の値自体を書き換える関数のためにある。
            Hm.OutputPane.output(L"関数の返り値:" + retValue + L"\r\n");
            for (auto arg : updatedArgs) {
                // 対象が数値タイプなら
                if (std::holds_alternative&lt;THmNumber&gt;(arg)) {
                    THmNumber v = std::get&lt;THmNumber&gt;(arg);
                    Hm.OutputPane.output(L"arg:" + to_wstring(v) + L"\r\n");
                }
                // 対象が文字列タイプなら
                else if (std::holds_alternative&lt;wstring&gt;(arg)) {
                    wstring v = std::get&lt;wstring&gt;(arg);
                    Hm.OutputPane.output(L"arg:" + v + L"\r\n");
                }

            }
        }
        else
        {
            Hm.OutputPane.output(L"実行失敗\r\n");
        }
    }
    catch (exception e) {
        Hm.OutputPane.output(Text::Encoding::utf8_to_utf16(e.what()));
    }

    return 1;
}
</pre>
            </fieldset>
</li></ul></div>

<div class="content-box mb-3 content-lighten">
    <h3>
        引数が書き換わる関数
    </h3>
    <p>C++の型に対する支援を期待するのなら、そのままHm.Macro.doFunction...と利用するよりも、<br>
        ラップするのがおすすめです。<br>
        また、秀丸マクロの関数にはごく一部、返り値のみならず、<mark>引数に渡している変数自体に値が入ってくる</mark>ものもあります。<br>
        例えば<mark>getlinecount (秀丸v8.94以降)</mark>や<mark>enumregvalue (秀丸v9.00以降)</mark>などが該当します。<br>
        こういったものも取得できるようになっています。</p>
    <p>今回は「<a href="https://help.maruo.co.jp/hidemac/html/070_Function_getlinecount.html">秀丸マクロ関数のgetlinecount</a>」をラップしてみましょう。</p>
    <ul class="pointlist">
        <li>
            <h4>C++側のソース</h4>
            <fieldset class="code">
                <legend>dllmain.cpp</legend>
                <pre class="brush:csharp;highlight:[9, 14,15]">#include "HmCppInvoke.h"

using namespace Hidemaru;
using namespace std;

std::tuple&lt;THmNumber, THmNumber&gt; getlinecount(wstring text, THmNumber index) {
    try {
        THmNumber dummycolumn = 0;
        auto ret = Hm.Macro.doFunction(L"getlinecount", text, index, dummycolumn); // 秀丸マクロ関数の「getlinecount」を呼び出してみる例。
        if (!ret.getException())
        {
            THmNumber lineno = ret.getResult&lt;THmNumber&gt;();

            auto upArgs = ret.getArgs(); // getArgs()で引数(text, index, dummycolumn)の関数実行後の値がvector&lt;THmMacroVariable&gt;の形で取得できる。
            THmNumber column = get&lt;THmNumber&gt;(upArgs[2]); // 関数に渡した３番めの引数(0オリジンでindex2のdummycolumn)が、関数の実行後どうなったのか取得。
            return { lineno, column };
        }
    }
    catch (exception e) {
    }
    return { 0,0 };
}

extern "C" __declspec(dllexport) THmNumber test() {
    Hm.funcDllExport();

    auto [lineno, column] = getlinecount(L"ABCD\nXYZ", 7);
    Hm.OutputPane.output(to_wstring(lineno) + L", " + to_wstring(column) + L"\r\n");


    return 1;
}
</pre>
            </fieldset>
    </li></ul>
</div>

<div class="content-box mb-3 content-lighten">
    <h3>Hm.Macro.doFunction(...) の返り値</h3>
    <ul class="arrowlist">
        <ul class="arrowlist">
            <li>
                <h5>getResult()メソッド</h5>
                <p>
                    実行した秀丸マク関数の返り値がTHmMacroVariable型で入っています。<br>
                    取得するにはテンプレートでの型指定、もしくは、std::get&lt;T&gt;での取得が必要です。
                </p>
            </li><li>
                <h5>getArgs()メソッド</h5>
                <p>
                    秀丸マク関数を実行した後、秀丸マクロ関数に渡した引数が最終的にどういった値になったかを取得できます。<br>
                    vector&lt;THmMacroVariable&gt;型で、関数に渡した最初の引数が[0], 次の引数が[1], ... といった形で格納されています。
                    各種リスト要素は、std::get&lt;T&gt;での取得が必要です。
                </p>
            </li><li>
                <h5>getException()メソッド</h5>
                <p>
                    何か明確な例外が発生した場合はexception型の例外インスタンスが入っています。<br>
                    例外が入っていない場合は、std::nullopt が入っっている。
                </p>
            </li>
            <li>
                <h5>getMessage()メソッド</h5>
                <p>
                    基本的には特になにもはいっておらず、空文字が入っています。<br>
                </p>
            </li>
        </ul>
</ul></div>

<div class="content-box mb-3 content-lighten">
    <h3>
        返り値が不明な関数はうまくいかない<br>
    </h3>
    <p>秀丸マクロの関数にはCOMなどで利用する「member関数」など、<br>
        ごく一部「<mark>関数だけではその返り値が数値なのか文字列なのか区別が付かないもの</mark>があります。<br>
        こういった関数は、うまくいきません。<br>
        これらは、Hm.Macro.doEval(...)、getVar、setVar、などを利用してラップしましょう。
    </p>
</div>