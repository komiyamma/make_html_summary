<div class="content-box mb-3 content-lighten">
<h2><i class="fa fa-book fa-fw"></i>HTMLの高度なパース</h2>
</div>
<div class="content-box mb-3 content-lighten">
    <h3>概要</h3>
    <p>IronPythonの例題のひとつとなります。<br>
    </p>
    <p>少々崩れたHTMLデータであってもDOMとして解析し、要素の抽出や置き換えが可能な <a href="https://htmlagilitypack.codeplex.com/">HTML Aglity Pack</a> を利用したサンプルです。<br>
    </p>

    <p>マネージドdll(.NET用DLL)だけ公開されているような「配布ライブラリ」を、<br>
    hmPyを経由して、いかに手軽に秀丸マクロから利用するか、といったサンプルでもあります。</p>
    <p><img src="./other_soft/hm_ironpython/cnt_hm_ironpython_htmlagility_01.png"></p>
</div>
<div class="content-box mb-3 content-lighten">
    <h3>ダウンロード</h3>

	  <div class="card mb-3 ms-3" style="max-width: 30rem;">
	    <div class="card-body text-center">
              <div class="row">
              <div class="col-12"><small>更新日 %(year)04d/%(mon)02d/%(mday)02d</small></div>
              </div>
	      <a href="%(file)s" class="btn btn-primary"><i class="fa fa-download fa-fw"></i>HmHtmlAgility.zip v1.20</a>
	    </div>
	  </div>

    <p>このhmHtmlAgility.zipには変換元のHTMLとなるサンプルファイルa.htmlが含まれています。</p>
</div>
<div class="content-box mb-3 content-lighten">
    <h3>説明</h3>
    <p>HTMLの要素を解析し、その中身を取り出したい、といったことは珍しいことではありません。<br>
    しかし、「フォーマット的に正しいことが期待できるXMLやRSS」とは異なり、<br>
    HTMLは人の手が多分に混じっていることが多いため、不正なフォーマット(崩れた状態の)ものが多いの特徴です。<br>
    (一つも誤りがないHTMLの方が珍しいことでしょう)</p>
</div>
<div class="content-box mb-3 content-lighten">
    <h3>IronPythonの部分</h3>
    <p>IronPythonの部分では、HTML Agility Packを利用しつつ、<br>
    「HTMLのロード」「toInnerText」「toInnerHtml」「新たなHTMLへのセーブ」という４つの関数に分けて制作してみました。 秀丸マクロから呼び出されることを意識したインターフェイスと言えるでしょう。</p>
    <div class="code"><pre class="brush:python">#coding: cp932

DEBUG = 1

import clr
import sys
sys.path.append(hm.Macro.Var["currentmacrodirectory"])

import System
import System.IO
import System.Text
import System.Collections.Generic


clr.AddReferenceByPartialName( "HtmlAgilityPack")
clr.AddReferenceByPartialName( "System.Windows.Forms" )

from HtmlAgilityPack import *
from System.Collections.Generic import *

load_html_filename = hm.Macro.Var["$load_html_filename"]
save_html_filename = hm.Macro.Var["$save_html_filename"]
file_encode = hm.Macro.Var["#encode"]

doc = ""


# htmlのロード。秀丸から操作しやすくするためにこのような単純なインターフェイスで
def LoadHTML():
    global doc
    si = None
    try:
        si = System.IO.StreamReader( load_html_filename, System.Text.Encoding.GetEncoding(file_encode) )
    except:
        System.Windows.Forms.MessageBox.Show("load_html_filename中にエラーが発生しました")
        if si:
            si.Close()
        raise IOError

    doc = HtmlDocument()
    doc.LoadHtml(si.ReadToEnd())
    si.Close()


# 対象のタグの中身はテキストだけになる(タグも除去される)
def toInnerText(tag):
    global doc
    q = doc.DocumentNode.Descendants(tag)
    l = List[HtmlNode](q)
    for item in l:
        newNodeStr = item.InnerText
        newNode = HtmlNode.CreateNode(newNodeStr)
        item.ParentNode.ReplaceChild(newNode, item)


# 対象のタグは除去するが、他のタグは残る
def toInnerHtml(tag):
    global doc
    q = doc.DocumentNode.Descendants(tag)
    l = List[HtmlNode](q)
    for item in l:
        newNodeStr = item.InnerHtml
        newNode = HtmlNode.CreateNode(newNodeStr)
        item.ParentNode.ReplaceChild(newNode, item)


# htmlのセーブ。秀丸から操作しやすくするためにこのような単純なインターフェイスで
def SaveHTML():
    global doc
    try:
        so = System.IO.StreamWriter( save_html_filename, False, System.Text.Encoding.GetEncoding(file_encode) )
        so.Write(doc.DocumentNode.InnerHtml)
        so.Close()
    except:
        System.Windows.Forms.MessageBox.Show("save_html_filename中にエラーが発生しました")
        if so:
            so.Close()
        raise IOError
</pre></div>
</div>
<div class="content-box mb-3 content-lighten">
    <h3>マクロ側の処理</h3>
    <p>マクロ側では「ロードファイル」や「セーブファイル」を指定することとなるでしょう。<br>
    今回はエンコーディングについては、「UTF-8」固定としました。<br>
    ローカルなどの作業用テキストなどとは異なり、<br>
    Web用のHTMLについては、近年では様々な都合により、ほとんどのケースでUTF-8で記述されているようです。</p>
    <p>マクロとして開いている html ファイルに対して…</p>
    <ul>
        <li><span class="negative">titleタグについては、中身のテキストだけに置き換える(タグを除去)</span>
        </li><li><span class="negative">blockquoteタグについては、中身のHTMLだけに置き換える(一番外のblockquoteタグだけを除去)</span>
    </li></ul>
    <p>それを 元のファイル名 + 「_up.html」という形にして秀丸で開いています。</p>
    <div class="code"><pre class="brush:python">#PY = loaddll( hidemarudir + "\\hmPY.dll" );
if (!#PY) {
  message("hmPYが未導入");
}
 
 
$load_html_filename = filename2;
$save_html_filename = directory2 + "\\" + basename2 + "_up.html";
#encode = codepage;
 
#_ = dllfuncw( #PY, "DoFile", currentmacrodirectory + "\\hmHtmlAgility.py" );

#_ = dllfuncw( #PY, "DoString", R"IPY(

LoadHTML()
toInnerText('title')
toInnerHtml('blockquote')
SaveHTML()

)IPY"
);

freedll( #PY );

openfile $save_html_filename;
    </pre></div>
</div>
<div class="content-box mb-3 content-lighten">
    <h3>ライセンス</h3>
    <ul class="pointlist">
        <li>
        <h4>HmHtmlAgility.pyとHmHtmlAgility.macについて</h4>
        <p>パブリックドメインとします。(即ち利用は自由)</p>
        </li><li>
        <h4>Html Agility Packについて</h4>
        <p>Simon Mourierの著作物であり、Microsoft Public License(Ms-PL) ライセンスとなります。<br>
        詳細は<a href="http://htmlagilitypack.codeplex.com/license">Html Agility Packのライセンス</a>を確認してください。</p>
    </li></ul>
</div>